---
layout: post
title: Cucumber
date: 2017-04-18 13:17:39 +0300
access: public
categories: [cucumber]
---

<!-- more -->

_Rakefile_:

```ruby
require 'cucumber/rake/task'

desc 'Run acceptance tests'
Cucumber::Rake::Task.new(:features) do |task|
  # default options are set in cucumber.yml
  task.fork = false
end
```

_config/cucumber.yml_:

```yaml
<% common_options = '--format pretty' %>

default: <%= common_options %> features
```

to enable syntax highlighting for feature files in vim
it's not required to install `tpope/vim-cucumber` plugin.

## aruba

### configuration

_features/support/aruba.rb_:

```ruby
require 'aruba/cucumber'
```

that's all that is required to use aruba steps in your features.

### working directory

by default aruba working directory is _tmp/aruba/_
(this is where all temporary files are created).

### set home directory to working directory

mock home directory (set HOME environment variable to aruba working directory):
<https://relishapp.com/philoserf/aruba/docs/environment/mock-the-home-variable>.

### environment variables and dotenv

it's safe to set environment variables in tests - dotenv will not overwrite
existing environments (unless instructed to do so with `Dotenv.overload`).

### logging to STDOUT and STDERR

<https://relishapp.com/philoserf/aruba/docs/command/run-commands-in-ruby-process#use-$stderr,-$stdout-and-$stdin-to-access-io>

use `$stdout` and `$stderr` global variables instead of `STDOUT` and `STDERR`
constants because they don't work when running application in the same process
as aruba.

## troubleshooting

### syntastic doesn't find aruba step definitions

- https://github.com/tpope/vim-cucumber/issues/30
- http://fasteragile.com/blog/2015/05/15/highlighting-undefined-cucumber-step-definitions-with-syntastic-in-vim/

#### description

it's necessary to require `aruba/cucumber` so that syntastic could find
aruba step definitions. this file is required in _features/support/env.rb_
as recommended in aruba documentation. but syntastic kept on showing
`Cucumber::Undefined` errors for all aruba steps.

#### solution

I edited _~/.vim/vimrc_ to run cucumber with syntastic profile:

```vim
let g:syntastic_cucumber_cucumber_args='--profile syntastic'
```

and required _features/support_ directory explicitly for syntastic profile
in _config/cucumber.yml_:

```yaml
<% common_options = '--format pretty' %>

default: <%= common_options %> features
syntastic: -r features/support <%= common_options %> features
```

but that didn't help.

in the end it turned out the problem was with the name of support file -
syntastic refused to find exactly _features/support/env.rb_.

btw `aruba init --test-framework cucumber` generates _features/support/aruba.rb_
so I renamed _env.rb_ to _aruba.rb_ too. after that syntastic no longer showed
errors for aruba steps - only for not implemented ones. moreover filename doesn't
even matter - it can be anything but _env.rb_.

long story short:

syntastic doesn't require _features/support/env.rb_ for some reason -
just rename it to something else (say, _aruba.rb_). no modifications to
_config/cucumber.yml_ or _~/.vim/vimrc_ are necessary.

### environment variables are not loaded with dotenv

#### description

<https://github.com/bkeepers/dotenv>:

> By default, load will look for a file called .env in the current working directory.

but cucumber changes cwd so _.env_ cannot be found in tests and
environment variables are not loaded accordingly.

#### solution

get path of _.env_ file relative to current file (say, _bin/my_app.rb_)
and load it explicitly:

```ruby
require 'dotenv'
Dotenv.load(File.expand_path('../../.env', __FILE__))
```

### false positive in the step `the following files should exist`

- <https://github.com/cucumber/aruba/blob/master/lib/aruba/cucumber/file.rb>
- <https://github.com/cucumber/aruba/blob/master/lib/aruba/api/filesystem.rb>

#### description

any string in the first line of data table provided as argument to the step
`the following files should exist` is considered to be an existing file.

#### solution

it has turned out that the latest release (v0.14.2) has bug in
_lib/aruba/cucumber/file.rb:82_:

```ruby
files = files.rows.flatten
```

here `files.rows` returns all rows in data table except header but according to
[docs](https://github.com/cucumber/aruba/blob/master/features/testing_frameworks/cucumber/steps/filesystem/existence_of_file.feature#L23)
data table argument to this step doesn't have a header -
thus the first line in data table (which is a file to be checked for presence)
is treated as a header (which can be anything - it's ignored anyway).

in the line above `raw` function should be used instead:

```ruby
files = files.raw.flatten
```

here `files.raw` returns all rows including header.
this is fixed in master branch.

long story short:

use master branch or provide fake header in data table when checking files
for existence or not existence.
