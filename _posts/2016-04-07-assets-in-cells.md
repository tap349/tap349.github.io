---
layout: post
title: assets in cells
date: 2016-04-07 02:01:46 +0300
access: public
categories: [rails, assets, cells]
---

how to bundle assets in cell's view directory.

<!-- more -->

<http://trailblazer.to/gems/cells/rails.html#asset-pipeline>

## basics

- add _app/cells/_ to assets paths

  _config/initializers/assets.rb_:

  ```ruby
  Rails.application.config.assets.paths << Rails.root.join('app', 'cells')
  ```

  now it's possible to `require` assets in application manifests
  specifying their paths relative to _app/cells/_.

- create _cells.sass_ and _cells.coffee_ and require them in application manifests

  _application.sass_:

  ```sass
  /*
   *= require cells
   */
  ```

  _cells.sass_:

  ```sass
  /*
   * require all cell stylesheets explicitly
   *
   *= require billing/accounting_act/accounting_act
   */
  ```

  the same for _cells.coffee_.

- make _cells.css_ and _cells.coffee_ be precompiled in production

  <http://guides.rubyonrails.org/asset_pipeline.html#how-to-use-the-asset-pipeline>

  asset compilation:

  - converting Coffee/SASS to JS/CSS
  - minification (we use `Uglifier` minificator)

  after compilation:

  - compiled assets are placed into _public/assets/_
  - compiled asset file name contains asset digest

  by default only _application.js_, _application.css_ and all non-JS/CSS
  in _app/assets/_ are precompiled (assets to be precompiled must be
  specified using final compiled file names with JS/CSS extension).

  2 ways to precompile _cells.sass_ (the same is true for _cells.coffee_):

  - if it is required in application manifest it will be precompiled
    automatically and included into compiled application manifest
  - if it is not required in application manifest it's possible to
    precompile it manually by adding it to precompile array in
    _config/initializers/assets.rb_:

    ```ruby
    Rails.application.config.assets.precompile += %w(cells.css)
    ```

## using asset tag helpers

<http://trailblazer.to/gems/cells/helpers.html#asset-helpers>

asset tag helpers provided by `Cell::ViewModel` ignore Rails assets prefix
(`/assets`) - they use different prefixes for different assets:
`/stylesheets` for stylesheets, `/javascripts` for javascripts, etc.
as a result sprockets cannot find assets using URLs generated by these helpers.

including `ActionView::Helpers::AssetTagHelper` into cell doesn't help.

**solution**: use original asset tag helpers provided by controller's view context.

_app/cells/my_cell.rb_:

```ruby
class MyCell < Cell::ViewModel
  delegate :wicked_pdf_stylesheet_link_tag, to: :view_context

  ...
private

  def view_context
    parent_controller.view_context
  end

  ...
end
```

in specs either stub `view_context`:

_app/cells/my_cell_spec.rb_:

```ruby
describe MyCell do
  let(:view_context) { double wicked_pdf_stylesheet_link_tag: nil }
  before { allow(act_cell).to receive(:view_context).and_return view_context }

  ...
end
```

or specify controller to make `view_context` available:

```ruby
describe MyCell do
  controller Billing::AccountingActsController

  ...
end
```

also when using assets tag helpers outside of application layout don't forget
to add referenced assets to precompile array in _config/initializers/assets.rb_.

otherwise these assets won't have their own compiled counterparts in
_public/assets/_ after compilation and consequently won't be found by
generated script or stylesheet tags - even if they are required in
application manifests and thusly included into their compiled counterparts.
