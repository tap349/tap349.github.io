---
layout: post
title: Ecto - Tips
date: 2018-12-28 22:04:58 +0300
access: public
comments: true
categories: [elixir, ecto]
---

<!-- more -->

* TOC
{:toc}
<hr>

(how to) get query SQL
----------------------

1. <https://hexdocs.pm/ecto/Ecto.Adapters.SQL.html#to_sql/3>

```elixir
> import Ecto.Query
> query = from p in User
#Ecto.Query<from u in User>
> Ecto.Adapters.SQL.to_sql(:all, Repo, query)
{"SELECT u0.\"id\", u0.\"name\" FROM \"users\" AS u0", []}
```

(how to) perform bulk updates
-----------------------------

1. <https://adamdelong.com/bulk-update-ecto>

### Repo.update_all/3

performing bulk updates with `Repo.update_all/3` is not super fast -
say, it took about 5 minutes to run this query against 2.3M rows:

```sql
(from s in MyApp.Shop, where: s.status == ^:fetched)
|> MyApp.Repo.update_all([set: [status: :linked]], [timeout: 300_000])
```

(how to) to use atoms in queries
--------------------------------

> <https://github.com/elixir-ecto/ecto/pull/954#issuecomment-139908835>
>
> Thank you but if people want to have atoms that become strings behind
> the scenes, or even an integer, reproducing enum types, they can
> interpolate the atom: `^:foo`. I wouldn't have it as a literal or as
> part of the query syntax exactly because it is not supported by any
> type by default. :)

```elixir
import Ecto.Query

def pending do
  Shop
  |> where(status: ^:pending)
  |> Repo.all()
end
```
