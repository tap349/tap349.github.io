---
layout: post
title: capybara
date: 2016-04-09 21:47:40 +0300
access: private
categories: [capybara]
---

Capybara notes.

<!-- more -->

* TOC
{:toc}

## about

key benefits:

- no setup (works out of the box for Rails and Rack applications)
- intuitive API (mimics user language)
- switch backends without changes to tests
- no need to manually wait for async process to complete

Capybara:

- just an API that provides a layer of abstraction on top of
  actual automation library (driver) - like Selenium WebDriver
- written in ruby
- supports testing web applications written in many languages and frameworks
  (though originally was created for testing Rails applications)
- provides DSL for test automation
- allows to write tests once and run them in any compatible driver
- has built-in drivers - additional drivers are available as gems
- handles asynchronous JS without the user even noticing

## installation

_Gemfile_:

```ruby
gem 'capybara'
```

_rails_helper.rb_ (not required indeed):

```ruby
require 'capybara/rails'
```

## RSpec integration

_rails_helper.rb_ (not required indeed):

```ruby
require 'capybara/rspec'
```

in Rails RSpec can be configured to infer spec type from a file location:

```ruby
RSpec.configure do |config|
  config.infer_spec_type_from_file_location!
end
```

in this case all specs in _spec/features/_ have type `feature`
(Capybara specs).

or else just tag example groups with `type: :feature` manually
if file location is different.

## drivers

### using JS driver

use `js: true` option to switch to JS driver (`selenium` by default).

### switching drivers

- set default driver globally in _rails_helper.rb_:

  ```ruby
  Capybara.default_driver = :selenium
  # default JS driver - when `js: true` is used
  Capybara.javascript_driver = :webkit 
  ```

- set current driver temporarily in before/after blocks:

  ```ruby
  Capybara.current_driver = :webkit # before block
  Capybara.use_default_driver       # after block
  ```

- set driver for specific test using `driver` option:

  ```ruby
  describe 'some stuff which requires js', :js => true do
    it 'will use the default js driver'
    it 'will switch to one specific driver', :driver => :webkit
  end
  ```

**NOTE**: switching driver creates a new session - you may not be able
          to switch in the middle of a test.

### driver types

headless drivers don't require display server (X11, Xvfb, etc.) -
all drivers mentioned below except Selenium are headless.

#### RackTest

- default driver (`rack_test`) - fast but limited
- doesn't support executing JS
- headless driver
- directly interacts with Rack interfaces -
  doesn't require a server to be started
- can be used with Rack apps only
- cannot access HTTP resources outside of Rack app
  (e.g., redirects to external sites, external APIs)

for RSpec it's better have `rack_test` as default driver and
mark tests that require JS support with `js: true` to use default JS driver.

#### Selenium

- `selenium-webdriver` gem
- supports executing JS
- not headless driver (Firefox must be installed)

#### Capybara-webkit

- `capybara-webkit` gem
- supports executing JS
- headless driver

#### Poltergeist

- `poltergeist` gem
- supports executing JS
- headless driver
- integrates Capybara with PhantomJS
  (runs tests on headless WebKit browser provided by PhantomJS)

## DSL

- by default Capybara will only locate visible elements
- all searches are case-sensitive (because XPath is case-sensitive)

Capybara alias | RSpec method
---------------|---------------------------------
`feature`      | `describe ..., type: :feature`
`background`   | `before`
`scenario`     | `it`
`let`/`let!`   | `given`/`given!`

## selectors

CSS is default selector.

XPath selector can be specified inline:

```ruby
find(:xpath, '//ul/li').text
```

or set as default selector:

```ruby
Capybara.default_selector = :xpath
find('//ul/li').text
```

## navigation

```ruby
visit 'http://www.youtube.com'
```

