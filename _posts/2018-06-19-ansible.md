---
layout: post
title: Ansible
date: 2018-06-19 01:34:36 +0300
access: private
comments: true
categories: [ansible]
---

<!-- more -->

* TOC
{:toc}
<hr>

<dl>
  <dt>Ansible project</dt>
  <dd>= playbook project</dd>

  <dt>playbook</dt>
  <dd>playbook consists of plays</dd>

  <dt>play</dt>
  <dd>maps a group of hosts to roles in playbook</dd>
</dl>

<hr>

1. <https://docs.ansible.com/ansible/latest/user_guide/intro_getting_started.html>
2. <https://github.com/leucos/ansible-tuto>

installation
------------

```sh
$ brew install ansible
```

add SSH config entry for remote node:

```sshconfig
# .ssh/config

Host sithex
 User root
 Hostname DIGITAL_OCEAN_IP
 IdentityFile ~/.ssh/id_rsa
 ForwardAgent yes
```

install Python on remote node:

```sh
$ ssh sithex
# apt install python
```

configuration
-------------

create inventory file:

> <https://github.com/leucos/ansible-tuto/tree/master/step-03>
>
> Hosts in inventory can be grouped arbitrarily. For instance, you could
> have a debian group, a web-servers group, a production group, etc...

```yaml
[web]
sithex
```

`[web]` here is a group name (optional).

now ping all nodes:

> <https://github.com/leucos/ansible-tuto/tree/master/step-02>
>
> `all` is a shortcut meaning 'all hosts found in inventory file'.

```
$ ansible all -m ping
sithex | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
```

execute shell command on specific node:

```
$ ansible sithex -m shell -a 'date'
sithex | SUCCESS | rc=0 >>
Mon Jun 18 22:58:35 UTC 2018
```

notes
-----

### roles

roles are executed once within one play only (where hosts are specified) -
not across all plays and playbooks in Ansible project:

> <https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html>
>
> Role dependencies are always executed before the role that includes them, and
> may be recursive. Dependencies also follow the duplication rules specified above.

### pre_tasks

> <https://docs.ansible.com/ansible/2.5/reference_appendices/playbooks_keywords.html#play>
>
> pre_tasks
>   A list of tasks to execute before roles.

> <https://github.com/Mohitsharma44/ansible-playbooks/wiki/vars-pre-post-and-handlers#pre_tasks-and-post_tasks>
>
> A general use case for pre_task could be when you need to make sure that your
> system package manager's cache is updated.

### vars

> <https://stackoverflow.com/a/42109037>
>
> Role variables defined in `vars` have a very high precedence - they can only
> be overwritten by passing them on the command line, in the specific task or in
> a block. Therefore, almost all your variables should be defined in `defaults`.

> <https://codereviewvideos.com/course/ansible-tutorial/video/variable-precedence-where-to-put-your-role-vars>
>
> I use `vars` directory for system specific variables.
>
> Everything else - all standard, shared variables we would need and anything
> we want the user of our Role to override should go in `defaults/main.yml`.

### SSH user

1. <https://docs.ansible.com/ansible/2.4/intro_configuration.html#remote-user>

> <https://stackoverflow.com/a/36677811>
>
> Besides, ansible_user is used when we want to specifiy default SSH user in
> ansible hosts file where as remote_user is used in playbook context.

by default user from corresponding entry in SSH config is used but it might
be app user so it's better to specify SSH user to run Ansible as explicitly:

```cfg
# ansible.cfg

[defaults]

# formerly known as `user`
remote_user = root
```

tips
----

### common roles directory for Ansible projects

> <https://docs.ansible.com/ansible/devel/user_guide/playbooks_reuse_roles.html#role-search-path>
>
> In Ansible 1.4 and later you can configure an additional roles_path to
> search for roles. Use this to check all of your common roles out to one
> location, and share them easily between multiple playbook projects.

environments
------------

1. <https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html#alternative-directory-layout>
2. <https://www.digitalocean.com/community/tutorials/how-to-manage-multistage-environments-with-ansible#using-ansible-constructs-that-allow-explicit-loading-order>

```yaml
# inventories/prod/group_vars/all

env: prod
```

```yaml
# inventories/stage/group_vars/all

env: stage
```

now `env` variable is available in all plays and roles.
