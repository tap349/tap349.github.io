---
layout: post
title: dry-rb
date: 2016-08-26 12:36:10 +0300
access: public
categories: [dry-rb, rspec]
---

dry-rb related notes.

<!-- more -->

### container stubs

- example usage: <https://github.com/dry-rb/dry-container/pull/11#issuecomment-184765175>
- source: <https://github.com/dry-rb/dry-container/blob/master/lib/dry/container/stub.rb>

#### setup

_config/environment.rb_:

```ruby
# Load and finalize DI container
require_relative '../system/reenter_builder/container'

# Enable container stubs in test environment only
if Rails.env.test?
  require 'dry/container/stub'
  ReenterBuilder::Container.enable_stubs!
end

# Don't finalize container in test environment at all since
# it freezes container class and you cannot:
# - enable stubs at all if you do it after container finalization
#   (since it extends container class with `Dry::Container::Stub`)
# - stub anything in your specs
ReenterBuilder::Container.finalize! unless Rails.env.test?
```

#### usage

- <https://discuss.dry-rb.org/t/example-changes-of-dependencies/50>

##### controller specs

the problem in controller specs is that you cannot stub specific
container entry in before block because by this time controller object
will have already been instantiated and injected with real objects.

##### PORO specs

```ruby
describe Item::Create do
  let(:operation) { described_class.new }

  let(:process_item) { double call: nil }
  before { MyApp::Container.stub('svcs.process_item', process_item) }
  before { operation.call }

  it { expect(process_item).to have_received(:call) }
end
```
