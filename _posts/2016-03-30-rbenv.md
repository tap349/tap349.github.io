---
layout: post
title: rbenv
date: 2016-03-30 18:54:42 +0300
access: public
categories: [rbenv, ruby]
---

migration from RVM to rbenv.

<!-- more -->

- <https://github.com/rbenv/rbenv>
- <http://makandracards.com/makandra/21545-rbenv-how-to-switch-to-another-ruby-version-temporarily-per-project-or-globally>

- rbenv stores ruby versions in _~/.rbenv/versions_
- global (default) ruby version is stored in _~/.rbenv/version_
- rbenv uses ruby version from _.ruby-version_ if it's present

## installation

- install rbenv itself and current ruby:

  ```sh
  $ brew install rbenv
  $ rbenv init
  $ rbenv install 2.3.0
  $ rbenv global 2.3.0
  ```

- install bundler and global gems:

  ```sh
  $ gem install bundler git-up powder
  ```

- run `bundle` inside each project's directory

## usage

- `rbenv version` - show current ruby version
- `rbenv versions` - list all installed ruby versions
- `rbenv global 2.3.0` - set default ruby version for current user
- `rbenv shell system` - set ruby version for current shell only

## sourcing

_.zshrc_:

```sh
eval "$(rbenv init -)"
```

## bundle exec and bundler binstubs

- <http://bundler.io/man/bundle-exec.1.html>:

> bundle exec command executes the command, making all gems specified
> in the Gemfile(5) available to require in Ruby programs.

also bundler is used to manage application dependencies (gemsets) -
RVM provides functionality to do it as well but bundler is a better way.
rbenv doesn't manage gemsets in contrast with RVM.

there might be multiple versions of the same gem installed for particular
ruby version but project uses gem versions from bundle
(specified in _Gemfile.lock_).

when running commands (`rake`, etc.) from within project directory it's necessary
to use gem versions from bundle - this can be done in 2 ways:

- run commands with `bundle exec`
- use bundler binstubs

### bundle exec

using `bundle exec` is okay except that it's necessary to type it whenever
you run gem commands:

- alias common commands to be run with `bundle exec` in _.zshrc_:

  ```sh
  alias guard='bundle exec guard'
  alias rake='bundle exec rake'
  alias rspec='bundle exec rspec'
  ```

  also make sure these commands are run with `bundle exec` in other aliases
  (alias definitions are non-recursive - like `noremap` mappings in vim):

  ```sh
  alias migrate='bundle exec rake db:migrate && RAILS_ENV=test bundle exec rake db:migrate'
  alias rollback='bundle exec rake db:rollback && RAILS_ENV=test bundle exec rake db:rollback'
  ```

- run `rspec` with `bundle exec` in _Guardfile_:

  ```ruby
  guard :rspec, cmd: 'bundle exec rspec -f doc', failed_mode: :none do
    ...
  end
  ```

### bundler binstubs

alternatively generate bundler binstubs with command:

```sh
$ bundle install --binstubs
```

to make rbenv aware of bundler binstubs use
[rbenv-binstubs](https://github.com/ianheggie/rbenv-binstubs) rbenv plugin.

```sh
$ rbenv which rspec
/Users/tap/.rbenv/versions/2.3.0/bin/rspec
```

## spring

<https://github.com/rails/spring>

when either using `bundle exec` or bundler binstubs
commands are NOT RUN via spring preloader!

to use spring preloader:

- run commands with `bundle exec spring`

  in previous releases of spring there was a warning about
  great performance penalty when using `bundle exec spring` -
  probably this is not the case now.

- use spring binstubs

  **RECOMMENDED WAY**

  **NOTE**: don't use spring in production!

  command `spring binstub --all` generates spring binstubs for 3 commands:

  - `rails`
  - `rake`
  - `rspec`

  also it generates _bin/spring_ executable which is loaded in
  each of these binstubs.
  in fact `bin/rails` is equivalent to `bin/spring rails`.

  **NOTE**: it's not possible to run other commands with spring.

  spring binstubs are run in context of bundle -
  no need to use `bundle exec` or bundler binstubs.
  moreover bundler binstubs shouldn't be used with spring binstubs since they
  are both stored in _bin_ directory by default and might overwrite each other.

## pow

<https://github.com/basecamp/pow/wiki/Troubleshooting#rbenv>

create _~/.powconfig_:

```sh
export PATH="$HOME/.rbenv/shims:/usr/local/opt/rbenv/bin:$PATH"
```

check where _bin_ is located - it's _/usr/local/opt/rbenv/bin_ if
rbenv was installed with brew.

don't forget to restart pow (or `kill -9` process better).

## command-t

switch to system ruby when compiling `command-t` vim plugin in _~.vim/update_bundles_:

```ruby
puts "compiling command-t..."

# https://langui.sh/2014/03/10/wunused-command-line-argument-hard-error-in-future-is-a-harsh-mistress
environment = 'ARCHFLAGS="-Wno-error=unused-command-line-argument-hard-error-in-future"'
command_t_path = File.join 'command-t', 'ruby', 'command-t'
rbenv_init_script = 'eval "$(rbenv init -)"'
command_t_build_script = 'rbenv shell system && ruby extconf.rb && make'

puts `zsh -c 'cd #{command_t_path} && #{rbenv_init_script} && #{environment} #{command_t_build_script}'`
```

## chef

RVM cannot be installed on debian 8 with `rvm` cookbook -
installing rbenv with `ruby_rbenv` cookbook went smoothly.

recipe:

```ruby
include_recipe 'ruby_build'
include_recipe 'ruby_rbenv::user'
```

attribute file:

```ruby
override['rbenv']['user_installs'] = [
  {
    'user' => 'deploy',
    'rubies' => ['2.3.0'],
    'global' => '2.3.0',
    'gems' => {
      '2.3.0' => [
        { 'name' => 'bundler' }
      ]
    }
  }
]
```

**NOTE**: `bundler` gem is not installed by default.
