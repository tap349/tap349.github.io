---
layout: post
title: Git - Tips
date: 2017-04-29 02:20:32 +0300
access: public
categories: [git]
---

<!-- more -->

* TOC
{:toc}
<hr>

## [how to] undo `git reset HEAD~`

<http://stackoverflow.com/questions/2510276/undoing-git-reset>

```sh
$ git reset 'HEAD@{1}'
```

or

```sh
$ git reset ORIG_HEAD
```

## [how to] fork a fork and sync it with original repo

- <https://help.github.com/articles/syncing-a-fork/>

<https://github.com/r-icarus/detergentex.git>
<br>-> <https://github.com/danxexe/detergentex> (fork with changes I need)
<br>-> <https://githbu.com/tap349/detergentex> (my fork)

what I want to get in the end is to use a fork synced with original repo.

```sh
$ git clone git@github.com:tap349/detergentex.git
$ git checkout feature/httpc-options-fork
$ git remote -v
$ git remote add upstream https://github.com/r-icarus/detergentex.git
$ git checkout master
$ git fetch upstream
$ git merge upstream/master
$ git checkout feature/httpc-options-fork
$ git rebase master
$ git mergetool
/ resolve conflicts
$ git rebase --continue
$ git clean -f
$ git push -f
```

## [how to] sign GitHub commits

### glossary

1. <https://superuser.com/a/769488/326775>

- keypair consists of a private signing key and a public verification key
- fingerprint is SHA-1 hash of the public key
- GPG key ID is a part of the fingerprint:
  - short key ID are the low 64 bits of the fingerprint
  - long key ID are the low 128 bits of the fingerprint

for example:

```sh
$ gpg --list-keys --keyid-format LONG
/Users/tap/.gnupg/pubring.gpg
-----------------------------
pub   rsa4096/ACFDF508F789A2CB 2017-10-17 [SC]
      D9CA996601640B2121F29312ACFDF508F789A2CB
...
```

here `ACFDF508F789A2CB` is a long GPG key ID and
`D9CA996601640B2121F29312ACFDF508F789A2CB` is a fingerprint.

### official guides

1. <https://help.github.com/articles/generating-a-new-gpg-key/>
2. <https://help.github.com/articles/associating-an-email-with-your-gpg-key/>
3. <https://help.github.com/articles/signing-commits-using-gpg/>

notes:

- use `gpg --full-generate-key` command to generate keypair

  key size of 2048 bits is used by default and it cannot be changed
  when using `gpg --gen-key` command.

### ~/.zshenv

- add `-S` flag to `git commit` command in all aliases
- export `GPG_TTY` environment variable

  1. <https://github.com/keybase/keybase-issues/issues/1712#issuecomment-141226705>

  ```zsh
  export GPG_TTY=$(tty)
  ```

  without it Git will fail to sign commits:

  ```
  $ git commit -S -m "foo"
  error: gpg failed to sign the data
  fatal: failed to write commit object
  ```

### ~/.zshrc

enable `gpg-agent` plugin to start `gpg-agent` (for caching passphrases):

```zsh
plugins=(... gpg-agent ...)
```

you'll have to enter your passphrase only once - when signing with GPG
for the first time after starting `gpg-agent` (as a rule it's restarted
on system reboot only).

**UPDATE**

probably that's not the case - I was asked for passphrase twice during the
same boot (`gpg-agent` wasn't stopped manually somewhere in the middle).

### ~/.gnupg/gpg.conf

1. <https://gist.github.com/bmhatfield/cc21ec0a3a2df963bffa3c1f884b676b>

```gpg
use-agent
```

according to `man gpg` this is a dummy option but without it
`git commit` command hangs and doesn't prompt for passphrase
(`pinentry` process having a very high CPU usage).

**UPDATE**

most likely this hang is caused by trying to make commits from inside MacVim:

- I run `:!publish` command in MacVim
- `pinentry` prompts for passphrase
- MacVim doesn't allow to enter passphrase
- I cancel command with `<C-c>`
- `pinentry` still waits for passphrase in the background
- I cannot make a commit from the command line because
  `pinentry` is still busy

TODO:

- remove `use-agent` optino from _gpg.conf_ and section about it above
- try to add `passphrase-file` option to _gpg.conf_ to avoid entering
  passphrase at all
  (https://github.com/keybase/keybase-issues/issues/1712#issuecomment-141226705)
- check if passphrase is asked for twice or more during the same boot

### ~/.gitconfig

- set commit email (required)

  ```sh
  $ git config --global user.email <GitHub verified email>
  ```

  if Git email doesn't match GitHub email,
  commit will have `Unverified` badge on GitHub).

- set signing key (optional)

  1. <https://stackoverflow.com/questions/41052538/git-error-gpg-failed-to-sign-data>

  ```sh
  $ git config --global user.signingkey <GPG key ID>
  ```

  I guess, setting signing key explicitly might be required if
  you have more than one signing key.
