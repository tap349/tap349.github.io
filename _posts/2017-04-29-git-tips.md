---
layout: post
title: Git - Tips
date: 2017-04-29 02:20:32 +0300
access: public
comments: true
categories: [git]
---

<!-- more -->

* TOC
{:toc}
<hr>

## (how to) undo `git reset HEAD~` or `git --commit amend`

1. <http://stackoverflow.com/questions/2510276/undoing-git-reset>
2. <https://stackoverflow.com/a/1459264/3632318>

```sh
$ git reset 'HEAD@{1}'
```

or

```sh
$ git reset ORIG_HEAD
```

when `git commit --amend` is undone, hash of the last commit is
restored to its original value -> changes can be safely pushed
to remote repo without `--force` option.

## (how to) fork a fork and sync it with original repo

- <https://help.github.com/articles/syncing-a-fork/>

<https://github.com/r-icarus/detergentex.git>
<br>-> <https://github.com/danxexe/detergentex> (fork with changes I need)
<br>-> <https://githbu.com/tap349/detergentex> (my fork)

what I want to get in the end is to use a fork synced with original repo.

```sh
$ git clone git@github.com:tap349/detergentex.git
$ git checkout feature/httpc-options-fork
$ git remote -v
$ git remote add upstream https://github.com/r-icarus/detergentex.git
$ git checkout master
$ git fetch upstream
$ git merge upstream/master
$ git checkout feature/httpc-options-fork
$ git rebase master
$ git mergetool
/ resolve conflicts
$ git rebase --continue
$ git clean -f
$ git push -f
```

## (how to) sign GitHub commits

### glossary

1. <https://superuser.com/a/769488/326775>

- keypair consists of a private signing key and a public verification key
- fingerprint is SHA-1 hash of the public key
- GPG key ID is a part of the fingerprint:
  - short key ID are the low 64 bits of the fingerprint
  - long key ID are the low 128 bits of the fingerprint

for example:

```sh
$ gpg --list-keys --keyid-format LONG
/Users/tap/.gnupg/pubring.gpg
-----------------------------
pub   rsa4096/ACFDF508F789A2CB 2017-10-17 [SC]
      D9CA996601640B2121F29312ACFDF508F789A2CB
...
```

here `ACFDF508F789A2CB` is a long GPG key ID and
`D9CA996601640B2121F29312ACFDF508F789A2CB` is a fingerprint.

### official guides

1. <https://help.github.com/articles/generating-a-new-gpg-key/>
2. <https://help.github.com/articles/associating-an-email-with-your-gpg-key/>
3. <https://help.github.com/articles/signing-commits-using-gpg/>

notes:

- use `gpg --full-generate-key` command to generate keypair

  key size of 2048 bits is used by default and it cannot be changed
  when using `gpg --gen-key` command.

### ~/.zshenv

- add `-S` flag to `git commit` command in all aliases
- export `GPG_TTY` environment variable

  1. <https://github.com/keybase/keybase-issues/issues/1712#issuecomment-141226705>

  ```zsh
  export GPG_TTY=$(tty)
  ```

  without it Git will fail to sign commits:

  ```sh
  $ git commit -S -m "foo"
  error: gpg failed to sign the data
  fatal: failed to write commit object
  ```

### ~/.zshrc

enable `gpg-agent` plugin to start `gpg-agent` (for caching passphrases):

```zsh
plugins=(... gpg-agent ...)
```

you'll have to enter your passphrase only once - when signing with GPG
for the first time after starting `gpg-agent` (as a rule it's restarted
on system reboot only).

**UPDATE**

probably that's not the case - I was asked for passphrase twice during the
same boot (`gpg-agent` wasn't stopped manually somewhere in the middle).
in any case this is no longer an issue since I read passphrase from file.

### ~/.gnupg/gpg.conf

1. <https://gist.github.com/bmhatfield/cc21ec0a3a2df963bffa3c1f884b676b>

- `use-agent` option

  I thought it was the absence of this option that caused `git commit`
  command to hang before asking for the passphrase but in fact the hang
  was caused by trying to make commits from inside MacVim:

  - I run `:!publish` command in MacVim
  - `pinentry` prompts for the passphrase
  - MacVim doesn't allow to enter the passphrase
    (the command runs in a non-interactive shell by default)
  - I cancel command with `<C-c>`
  - `pinentry` still waits for the passphrase in the background
    (correspoding process having a very high CPU usage)
  - I cannot make a commit from the command line because
    `pinentry` is still busy waiting for the passphrase

  TL;DR: `use-agent` option can be safely removed from _gpg.conf_.

- `passphrase-file` and `pinentry-mode` options

  1. <https://github.com/keybase/keybase-issues/issues/1712#issuecomment-141226705>

  use these options to read passphrase from file instead of entering
  it manually (especially useful when running `git commit` command in
  a non-interactive shell - say, from inside MacVim):

  ```gpg
  passphrase-file /Users/tap/.gnupg/passphrase
  pinentry-mode loopback
  ```

  don't use tilde in passphrase file path - or else:

  ```sh
  $ git commit -S -m "foo"
  error: gpg failed to sign the data
  fatal: failed to write commit object
  ```

  if `pinentry-mode loopback` option is missing passphrase won't be
  read from file at all - you will still have to enter it manually
  even though passphrase file is specified.

- `batch` option

  this option is supposed to be used along with `passphrase-file`
  option but it all works as is so the former can be omitted.

### ~/.gitconfig

- set commit email (required)

  ```sh
  $ git config --global user.email <GitHub verified email>
  ```

  if Git email doesn't match GitHub email,
  commit will have `Unverified` badge on GitHub.

- set signing key (optional)

  1. <https://stackoverflow.com/questions/41052538/git-error-gpg-failed-to-sign-data>

  ```sh
  $ git config --global user.signingkey <GPG key ID>
  ```

  I guess, setting signing key explicitly might be required if
  you have more than one signing key.
