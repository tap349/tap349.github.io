---
layout: post
title: rails i18n
date: 2016-03-29 10:11:50 +0300
access: public
categories: [rails i18n]
---

configuration of rails app to support I18n.

<!-- more -->

## routes

_routes.rb_:

```ruby
Rails.application.routes.draw do
  scope '(:locale)', locale: /en/ do
    # all your routes
  end
end
```

_application_controller.rb_:

```ruby
class ApplicationController < ActionController::Base
  before_action :set_locale

  ...

private

  def set_locale
    I18n.locale = params[:locale] || I18n.default_locale
  end

  def default_url_options options = {}
    options.merge locale: params[:locale]
  end

  ...
end
```

- with `en` locale (e.g. <http://test.com/en/foo>):

  - optional dynamic segment matches (`params[:locale] = 'en'`)
  - all other routes match as usual
  - `I18n.locale` is set `'en'` in `ApplicationController#set_locale`
  - `locale: en` option is merged into default URL options passed to all URL
    helpers - all generated URLs in current request will have path starting with `en/`

- with `ru` locale (e.g. <http://test.com/ru/foo>):

  - optional dynamic segment doesn't match
  - `no route matches` error because there is no route starting with `ru`

- without any locale (e.g. <http://test.com/foo>):

  - optional dynamic segment doesn't match (`params[:locale] = nil`)
  - all other routes match as usual
  - `I18n.locale` is set to default locale (`'ru'`) in `ApplicationController#set_locale`
  - `locale: nil` option is merged into default URL options passed to all URL
    helpers - all generated URLs in current request will have path without locale

this scheme doesn't work with custom URL generator class that includes
included `Rails.application.routes.url_helpers` module.
URL helpers available from this module won't have access to view context and
consequently to default URL options set in `ApplicationController` -
they will try to use the first argument as a value for `locale` parameter
which will result in `no route matches` error.
solution: don't use URL generator classes and pass view context explicitly
whenever it's necessary to use URL helpers outside of controller or view.

### active admin

AA controllers are not inherited from `ApplicationController` and
consequently don't have correct default URL options set.

that is why URL helpers in AA don't generate correct URLs
(for the same reason as URL helpers in custom URL generator classes above).

simple solution is to exclude AA routes from `locale` scope in _routes.rb_:

```ruby
Rails.application.routes.draw do
  scope '(:locale)', locale: /en/ do
    ...
  end

  ActiveAdmin.routes(self)
end
```

## rspec

locale is not set from `config.i18n.default_locale` in _application.rb_
(defaults to `:en`) and thusly has to be set manually in each spec:

```ruby
before { I18n.locale = :ru }
```

or else set it globally in either _spec/rails_helper.rb_ or
_spec/support/factory_girl.rb_
(or even better - create a separate file like _spec/support/i18n.rb_):

```ruby
RSpec.configure do |config|
  config.before :suite do
    I18n.locale = :ru
  end
end
```

also it's possible to set locale to default locale
(for some obscure reason rspec doesn't do it itself):

```ruby
I18n.locale = I18n.default_locale
```

**NOTE**: translations from class methods are loaded before `before` block!

## mailers

_application.rb_:

```ruby
config.action_mailer.default_url_options = {
  host: Pumba::DOMAIN, only_path: false, locale: I18n.locale
}
```

## sidekiq

<https://github.com/mperham/sidekiq/issues/750>

_config/initializers/sidekiq.rb_:

```ruby
require 'sidekiq/middleware/i18n'
```
