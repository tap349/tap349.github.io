---
layout: post
title: rbenv
date: 2016-03-30 18:54:42 +0300
access: public
categories: [rbenv, ruby]
---

moving from RVM to rbenv: migration guide.

<!-- more -->

- <https://github.com/rbenv/rbenv>
- <http://makandracards.com/makandra/21545-rbenv-how-to-switch-to-another-ruby-version-temporarily-per-project-or-globally>

takeaways:

- rbenv stores ruby versions in _~/.rbenv/versions/_
- global (default) ruby version is stored in _~/.rbenv/version_
- rbenv uses ruby version from _.ruby-version_ if it's present

## uninstallation of RVM

- remove RVM directory:

  ```sh
  $ rvm implode
  ```

  or else just:

  ```sh
  $ rm -rf ~/.rvm
  ```

- remove _~/.rvmrc_
- remove RVM source line from all rc files

  some of them were created by RVM purely for adding this line -
  remove such rc files completely

- remove _~/.rvm/bin/_ from `PATH` (in my case - in _.zshenv_ and _.profile_)

## installation

- install rbenv and ruby:

  ```sh
  $ brew install rbenv
  $ rbenv init
  $ rbenv install --list
  $ rbenv install 2.3.0
  $ rbenv global 2.3.0
  ```

- update list of available ruby versions

  list of available ruby versions is updated by upgrading ruby-build -
  rbenv plugin installed as dependency for homebrew rbenv package:

  ```sh
  $ brew update && brew upgrade ruby-build
  ```

- install bundler and global gems:

  ```sh
  $ gem install bundler git-up powder rubocop
  ```

- run `bundle` inside each project's directory

## usage

- `rbenv version` - show current ruby version
- `rbenv versions` - list all installed ruby versions
- `rbenv global 2.3.0` - set default ruby version for current user
- `rbenv shell system` - set ruby version for current shell only

## sourcing

_.zshrc_:

```sh
eval "$(rbenv init -)"
```

## bundler and spring

see [bundler and spring]({% post_url 2016-03-31-bundler-and-spring %}) for details.

## pow

<https://github.com/basecamp/pow/wiki/Troubleshooting#rbenv>

create _~/.powconfig_:

```sh
export PATH="$HOME/.rbenv/shims:/usr/local/opt/rbenv/bin:$PATH"
```

check where _bin/_ is located - this is _/usr/local/opt/rbenv/bin/_
if rbenv has been installed with brew.

don't forget to restart pow (or `kill -9` process better).

## command-t

switch to system ruby when compiling `command-t` vim plugin in _~.vim/update_bundles_:

```ruby
puts "compiling command-t..."

# https://langui.sh/2014/03/10/wunused-command-line-argument-hard-error-in-future-is-a-harsh-mistress
environment = 'ARCHFLAGS="-Wno-error=unused-command-line-argument-hard-error-in-future"'
command_t_path = File.join 'command-t', 'ruby', 'command-t'
rbenv_init_script = 'eval "$(rbenv init -)"'
command_t_build_script = 'rbenv shell system && ruby extconf.rb && make'

puts `zsh -c 'cd #{command_t_path} && #{rbenv_init_script} && #{environment} #{command_t_build_script}'`
```

if you install ruby with `brew` (`brew install ruby`) it will be used as
system ruby by rbenv and `command-t` won't work since it expects
its native extensions to be compiled with vim ruby version (2.0.0p648).

## chef

RVM cannot be installed on debian 8 with `rvm` cookbook -
installing rbenv with `ruby_rbenv` cookbook went smoothly.

recipe:

```ruby
include_recipe 'ruby_build'
include_recipe 'ruby_rbenv::user'
```

attribute file:

```ruby
override['rbenv']['user_installs'] = [
  {
    'user' => 'deploy',
    'rubies' => ['2.3.0'],
    'global' => '2.3.0',
    'gems' => {
      '2.3.0' => [
        { 'name' => 'bundler' }
      ]
    }
  }
]
```

**NOTE**: `bundler` gem is not installed by default.

## capistrano

<https://github.com/capistrano/rbenv>

this gem provides rbenv support for capistrano:
it allows to use rbenv managed rubies on target machine.

_Capfile_:

```ruby
require 'capistrano/rbenv'
```

_config/deploy.rb_:

```ruby
set :rbenv_type, :user
set :rbenv_ruby, File.read('.ruby-version').strip
set :rbenv_prefix, "RBENV_ROOT=#{fetch(:rbenv_path)} RBENV_VERSION=#{fetch(:rbenv_ruby)} #{fetch(:rbenv_path)}/bin/rbenv exec"
set :rbenv_map_bins, %w(rake gem bundle ruby rails)
set :rbenv_roles, :all
```
