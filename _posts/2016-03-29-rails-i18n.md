---
layout: post
title: rails i18n
date: 2016-03-29 10:11:50 +0300
access: public
categories: [rails i18n]
---

configuration of rails app to support I18n.

<!-- more -->

## routes

_routes.rb_:

```ruby
Rails.application.routes.draw do
  scope '(:locale)', locale: /en/ do
    # all your routes
  end
end
```

_application_controller.rb_:

```ruby
class ApplicationController < ActionController::Base
  before_action :set_locale

  ...

private

  def set_locale
    I18n.locale = params[:locale] || I18n.default_locale
  end

  def default_url_options options = {}
    options.merge locale: params[:locale]
  end
```

with `en` locale (e.g. http://test.com/en/foo):

- optional dynamic segment matches (`params[:locale] = 'en'`)
- all other routes match as usual
- `I18n.locale` is set `'en'` in `ApplicationController#set_locale`
- `{ locale: en }` option is merged into default URL options passed to all URL
  helpers - all generated URLs in current request will have path starting with `en`

with `ru` locale (e.g. http://test.com/ru/foo):

- optional dynamic segment doesn't match
- `no route matches` error because there is no route starting with `ru`

without any locale (e.g. http://test.com/foo):

- optional dynamic segment doesn't match (`params[:locale] = nil`)
- all other routes match as usual
- `I18n.locale` is set to default locale (`'ru'`) in `ApplicationController#set_locale`
- `{ locale: nil }` option is merged into default URL options passed to all URL
  helpers - all generated URLs in current request will have path without locale

this scheme doesn't work if you have custom URL generator class with included
`Rails.application.routes.url_helpers` module.
these URL helpers don't have access to view context and consequently
to default URL options set in `ApplicationController` -
they will try to assign the first argument to helper as the value
of `locale` parameter which will result in `no route matches` error.
solution: don't use such URL generator classes and pass view context explicitly
whenever it's necessary to use URL helpers outside of controller or view.

### active admin

AA controllers are not inherited from application controller
and consequently don't use _default_url_options_ defined there.

that is why url helpers in AA don't generate correct urls
(using the first argument to url helper as `locale` parameter value).

simple solution is to exclude AA routes from `locale` scope in _routes.rb_:

```ruby
Rails.application.routes.draw do
  scope '(:locale)', locale: /en/ do
    ...
  end

  ActiveAdmin.routes(self)
end
```

## rspec

locale is not set from `config.i18n.default_locale` in _application.rb_
(defaults to `:en`) and thusly has to be set manually in each spec:

```ruby
before { I18n.locale = :ru }
```

or else set it globally in _spec/rails_helper.rb_ or _spec/support/factory_girl.rb_
(or just create a separate file like _spec/support/i18n.rb_):

```ruby
RSpec.configure do |config|
  config.before :suite do
    I18n.locale = :ru
  end
end
```

also it's possible to set it to default locale
(rspec for some reason doesn't set locale to default locale):

```ruby
I18n.locale = I18n.default_locale
```

**NOTE**: translations from class methods are loaded before `before` block!

## mailers

_application.rb_:

```ruby
config.action_mailer.default_url_options = {
  host: Pumba::DOMAIN, only_path: false, locale: I18n.locale
}
```
